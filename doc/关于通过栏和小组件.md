# 通知栏与小组件显示方案

本文档说明如何让 Focus Garden 在通知栏、锁屏和桌面小组件中展示专注状态，并在应用启动时引导用户授予相关权限。

## 需求概述
- 在专注计时进行时，通知栏与锁屏界面需要持续展示任务名称与剩余时间。
- 通知支持快速操作（继续/暂停/结束），点击可返回应用。
- 锁屏/桌面小组件展示进度与快捷入口，无需打开应用即可查看。
- 首次进入应用时引导申请通知权限，若未授权需提示用户手动开启。

## 权限与系统设置
- `POST_NOTIFICATIONS`：Android 13+ 必须显式申请；未授权则无法推送通知。
- `FOREGROUND_SERVICE`：用于常驻通知的前台服务，Manifest 需声明。
- 锁屏展示：通知需设置 `VISIBILITY_PUBLIC`，同时在文案中提示用户在系统“锁屏通知/显示内容”中允许显示。
- 省电/后台限制：国产 ROM 可能限制前台服务，需在 UI 文案里提示用户将应用加入自启动/省电白名单。

## 通知栏常驻卡实现

### 设计要点
- 通知渠道：`focus_status`，重要性 `IMPORTANCE_LOW`（无声音，仅常驻）。
- 展示内容：标题显示当前专注任务，正文显示剩余时间、奖励加成等状态。
- 行为：`ongoing=true`，点击进入 Focus 页面；可选操作按钮：暂停/继续、结束。
- 锁屏可见：`setVisibility(Notification.VISIBILITY_PUBLIC)`，确保锁屏也显示内容。

### 安卓端步骤（Capacitor 容器）
1. **创建前台服务**：`FocusForegroundService`，接收 `title/remainingSeconds/isRunning` 等参数构建通知。
2. **注册通知渠道**：在 `onCreate` 初始化 `NotificationChannel("focus_status")`。
3. **处理操作按钮**：通过 `BroadcastReceiver` 响应暂停/结束意图，并使用 `LocalBroadcast` 或自定义 Capacitor 插件回传给 WebView。
4. **Manifest 配置**：
   - 声明 `<uses-permission android:name="android.permission.POST_NOTIFICATIONS" />`
   - 注册 `service` 与 `receiver`，并设置 `android:foregroundServiceType="dataSync|mediaPlayback"`（按需选择）。
5. **Capacitor 插件**：封装 `startService(payload) / updateService(payload) / stopService()`，供前端调用。

### 前端调用示例（伪代码）
```javascript
// src/services/notificationService.js
import { Capacitor } from '@capacitor/core'

const plugin = Capacitor.isNativePlatform()
  ? (await import('focus-status-plugin')).FocusStatusPlugin
  : null

export async function ensureNotificationPermission() {
  if (!plugin) return { granted: false }
  const status = await plugin.checkPermission()
  if (status.state === 'granted') return { granted: true }
  const result = await plugin.requestPermission()
  return { granted: result.state === 'granted' }
}

export async function startFocusNotification(payload) {
  if (!plugin) return
  await plugin.startService(payload) // payload: { title, remainingSeconds, isRunning, progress }
}

export async function updateFocusNotification(payload) {
  if (!plugin) return
  await plugin.updateService(payload)
}

export async function stopFocusNotification() {
  if (!plugin) return
  await plugin.stopService()
}
```

调用时机（建议）：
- 应用进入时调用 `ensureNotificationPermission()`，若未授权弹窗引导用户开启通知/锁屏显示。
- `开始专注` 时调用 `startFocusNotification`，`暂停/继续` 时调用 `updateFocusNotification`，`结束` 时调用 `stopFocusNotification`。

## 锁屏与桌面小组件

### 目标
- 锁屏/桌面小组件展示当前专注任务、剩余时间、进度条与快捷入口。
- 在专注状态更新时刷新小组件；结束后恢复默认提示。

### 安卓端步骤
1. **布局文件**：`android/app/src/main/res/layout/widget_focus.xml`，包含任务名、剩余时间、进度条、启动应用的 `PendingIntent`。
2. **Widget Provider**：`FocusWidgetProvider` 继承 `AppWidgetProvider`，在 `onUpdate` 中从 `SharedPreferences` 读取最新状态并更新 RemoteViews。
3. **数据同步**：在自定义 Capacitor 插件中提供 `updateWidget(payload)`，将状态写入 `SharedPreferences` 并触发 `AppWidgetManager.updateAppWidget`。
4. **Manifest**：注册 `<receiver android:name=".widget.FocusWidgetProvider">` 并指向 `res/xml/widget_focus_info.xml`。
5. **操作入口**：可在小组件上添加“开始/暂停”按钮，对应 `PendingIntent` 发送到 `BroadcastReceiver`，再通过插件通知 WebView。

### 前端同步建议
- 在专注计时 `setInterval` 的 tick 内，每 15~30 秒调用 `updateWidget`（避免过度刷新）。
- 结束或退出时发送空状态，重置小组件显示“暂无专注”。
- 若在网页端运行（非原生），`updateWidget` 可直接返回，保持无侵入。

## 进入应用时的权限引导
- 检查逻辑：启动时调用 `ensureNotificationPermission`，若返回未授权则弹出说明弹窗。
- 引导内容：说明通知/锁屏显示的作用，提供“去开启”按钮跳转系统通知设置；保留“稍后再说”。
- 兜底：未授权时不启动前台服务，也可在 UI 上提示“已降级为应用内显示”。

## 验证清单
- 通知权限未授权时：应用弹窗提示，拒绝后不崩溃，状态正常。
- 开始专注：通知栏出现常驻卡片，锁屏可见，内容与进度正确。
- 暂停/继续/结束：通知文案与按钮状态同步变化；结束后通知消失。
- 小组件：桌面添加后能实时更新剩余时间，点击可回到应用；结束后显示默认提示。
- 兼容性：在 MIUI/ColorOS 等需手动开启“锁屏显示/后台运行”时，应用内文案有指引。
