# 多用户登录与数据隔离方案

面向需求：用 B 站账号登录，UID 作为唯一用户标识；不同用户拥有独立的徽章、待办、专注记录、金币、下载等所有数据；Web（PC/移动端浏览器）提示“安装到主屏幕”。

---

## 1. 目标与范围

- 账号来源：B 站登录（二维码 / Cookie 手动录入），以 `mid` 作为用户 ID。
- 数据隔离：每个用户独享所有业务数据（待办、专注记录、徽章、推币机、音频播放记录、下载记录、音频平台配置等）。
- 多端体验：Web 端在 PC 和移动浏览器均弹出安装 PWA 的提示；安卓 APK 维持现有体验。
- 无后台前提：仍以 `localStorage` / `IndexedDB` 为主要持久化方式。

---

## 2. 总体方案

1. 新增 `userStore` 管理“当前用户 ID + 用户列表 + 会话信息”，对外暴露 `activeUserId`、`switchUser`、`logoutUser`、`listUsers`。
2. 所有存储 Key 改为按“用户 ID 后缀”命名（示例 `focus-garden-data::bili:123`），并在加载/保存时自动切换。
3. B 站会话改造为“多账号”存储（`bilibili-auth-sessions`），每个 UID 对应一份 Cookie/过期时间/头像昵称。
4. 兼容迁移：首次升级时把旧版单用户数据导入到一个默认用户（`local:legacy`），若发现已有 B 站登录信息则自动生成 `bili:<mid>` 用户并设置为当前用户。
5. PWA 安装提示：在 `App.vue`（或全局入口）监听 `beforeinstallprompt` 事件，缓存触发对象，分别在 PC/移动端显示 CTA；iOS 走“分享 → 添加到主屏幕”文案提示。
6. 组件复用：`BilibiliLogin.vue` 继续作为登录入口；新增 `InstallPrompt` 组件承载安装 CTA；设置页新增“账号与多用户”卡片与切换弹窗。

---

## 3. 存储模型与命名规范

### 3.1 用户元信息（新 Key）

- `focus-garden-user-meta`
  ```json
  {
    "activeUserId": "bili:123456",
    "users": {
      "bili:123456": {
        "uid": "123456",
        "source": "bilibili",
        "displayName": "哔哩昵称",
        "avatar": "https://...",
        "sessionKey": "bili:123456",
        "createdAt": "2025-12-04T06:00:00Z",
        "lastActiveAt": "2025-12-04T07:00:00Z"
      },
      "local:guest": {
        "uid": "guest",
        "source": "local",
        "displayName": "离线用户",
        "avatar": "",
        "sessionKey": null,
        "createdAt": "...",
        "lastActiveAt": "..."
      }
    }
  }
  ```

### 3.2 B 站多账号会话（新 Key）

- `bilibili-auth-sessions`
  ```json
  {
    "sessions": {
      "bili:123456": {
        "cookies": "SESSDATA=...; bili_jct=...",
        "userId": "123456",
        "userName": "哔哩昵称",
        "avatar": "https://...",
        "expiresAt": "2025-12-30T00:00:00Z",
        "lastValidatedAt": "2025-12-04T06:10:00Z"
      }
    }
  }
  ```
- `src/services/bilibiliAuth.js` 调整为：加载时读取 `userStore.activeUserId` 对应的 session；保存时写入 `bilibili-auth-sessions`，不再覆盖全局单一 `bilibili-auth`。

### 3.3 业务数据命名（按用户后缀）

| 模块 | 旧 Key | 新 Key 示例 |
| --- | --- | --- |
| 主数据（待办/专注/金币） | `focus-garden-data` | `focus-garden-data::bili:123456` |
| 徽章 | `focus-garden-badges` | `focus-garden-badges::bili:123456` |
| 推币机 | `focus-garden-machines` | `focus-garden-machines::bili:123456` |
| 音频播放 | `audiobook-player-data` | `audiobook-player-data::bili:123456` |
| 上次播放 | `audiobook-last-played` | `audiobook-last-played::bili:123456` |
| 下载管理 | `download-manager-data` | `download-manager-data::bili:123456` |
| 平台源配置 | `platform-source-data` | `platform-source-data::bili:123456` |
| 其他模块（如 future stores） | 按原 key | `原key::bili:123456` |

**加载/保存规则：** 所有 store 在读取/写入时通过 `getActiveKey(baseKey)` 拼接 `::<activeUserId>`，切换用户后需要重新初始化 state（或在 `userStore` 中触发 `resetAndLoadAll()`）。

---

## 4. 核心实现设计

### 4.1 userStore（`src/stores/userStore.js`）

- **状态**
  - `activeUserId`：当前用户 ID，形如 `bili:<uid>` / `local:guest`。
  - `users`：`Map<string, UserMeta>`，结构同 3.1。
  - `loadingUser`：切换时的 loading 状态。
- **方法**
  - `initFromStorage()`：启动时加载 `focus-garden-user-meta`，若不存在则创建 `local:guest`。
  - `registerOrUpdate(userMeta)`：登录成功后写入/更新用户资料。
  - `switchUser(userId)`：更新 `activeUserId`，写回 storage，并触发 `onUserSwitched` 事件。
  - `removeUser(userId, { removeData = false })`：可选删除对应数据 key（见 4.3）。
  - `logoutUser(userId)`：清除对应 session，但保留数据。
  - `listUsers()`：返回用户数组供 UI 渲染。
- **事件**
  - `onUserSwitched`：全局发布（可用 mitt/自定义事件），业务 store 监听后执行 reload。
  - `onUserRemoved`：供业务 store 清数据。

### 4.2 bilibiliAuth 改造（`src/services/bilibiliAuth.js`）

- **读写 session**
  - 新增 `loadSessionFor(userId)`：从 `bilibili-auth-sessions` 读取指定 UID 的 session。
  - 新增 `saveSession(userId, session)`：写入/更新 sessions；刷新 `expiresAt`。
  - `clearSession(userId)`：删除 sessions 中对应节点。
- **当前登录态**
  - `getAuthInfo` 等函数基于 `userStore.activeUserId` 返回会话。
  - 所有请求带上当前用户的 Cookie；若缺失则抛出“请先登录”。
- **示例伪码**
  ```javascript
  export function getActiveCookies() {
    const uid = userStore.activeUserId
    const session = loadSessionFor(uid)
    return session?.cookies || ''
  }
  ```

### 4.3 业务 store 适配模式

- 抽取工具函数 `withUserKey(baseKey)`：
  ```javascript
  import { useUserStore } from './userStore'
  const userStore = useUserStore()
  const getKey = base => `${base}::${userStore.activeUserId}`
  ```
- **加载**：`const saved = localStorage.getItem(getKey('focus-garden-data'))`
- **保存**：watch 对象时写回 `getKey(baseKey)`
- **切换**：监听 `onUserSwitched`，执行：
  1) 清空当前 state 为默认值
  2) 调用 `loadFromStorage()` 重新 hydrate
- **删除用户数据**：`removeUser` 时调用各 store 的 `removeDataFor(userId)`，统一从 `localStorage`/`IndexedDB` 删除 `::<userId>` 前缀的键。

### 4.4 迁移脚本（启动时执行一次）

伪码：
```javascript
function migrateIfNeeded() {
  const meta = loadMeta()
  if (!meta) {
    // 创建 guest
    createGuest()
    // 迁移旧数据
    migrateLegacyDataTo('local:legacy')
  }
  // 旧版单会话
  const oldAuth = loadOldBiliAuth()
  if (oldAuth?.userId) {
    upsertUserFromOldAuth(oldAuth) // 生成 bili:<uid> 用户与 session
  }
}
function migrateLegacyDataTo(userId) {
  const keys = ['focus-garden-data', 'focus-garden-badges', ...]
  keys.forEach(k => copyStorage(k, `${k}::${userId}`))
}
```
- 迁移成功后写入 `focus-garden-user-meta`，并标记 `migrated: true` 以防重复执行。

### 4.5 PWA 安装提示组件（`src/components/InstallPrompt.vue` 或 composable）

- **状态**：`available`、`deferredPrompt`、`isStandalone`、`lastPromptAt`。
- **流程**
  - 监听 `beforeinstallprompt`，阻止默认并存储事件。
  - 控制频率：`lastPromptAt` 与当前时间超过 24h 才显示 CTA。
  - 点击 CTA 调 `prompt()`，记录用户选择结果；成功后不再提示。
  - iOS：检测 `!window.matchMedia('(display-mode: standalone)').matches && !navigator.standalone && /iphone|ipad/.test(UA)`，展示图文指引。

### 4.6 UI 交互细节

- **切换弹窗**：列表展示头像/昵称/来源，点击切换；右侧“...” 提供“删除数据”“退出登录”。
- **删除确认**：分两步确认，提示将删除该用户所有本地数据与会话，且不可恢复。
- **冲突提示**：当切换用户会导致当前计时/下载中断时，先弹出确认（“切换后当前任务将暂停”）。

---

## 4. 迁移策略（兼容旧数据）

1. 检测 `focus-garden-user-meta` 是否存在；不存在则创建 `local:legacy` 用户并把旧 key 的数据复制到带后缀的新 key。
2. 若存在旧版 `bilibili-auth` 且能读出 `userId`，生成 `bilibili-auth-sessions` 中的 `bili:<userId>`，并在 `user-meta` 中新增该用户；若无其他用户，直接设为 `activeUserId`。
3. 迁移完成后不删除旧 key（首版可保留一版备份），待验证稳定后再择机清理。
4. 所有 store 的初始化逻辑需具备“缺省值兜底”，防止读到空对象时报错。

---

## 5. 登录/切换流程

1. **登录入口**：`OnlinePlayer` 现有的 `BilibiliLogin.vue` 复用；增加设置页「账号与多用户」入口，统一唤起登录/切换。
2. **登录成功**：`bilibiliAuth` 返回 `cookies + userInfo` → 写入 `bilibili-auth-sessions` → 在 `userStore` 中注册/更新用户（`bili:<mid>`）并切换为当前用户 → 所有业务 store 监听 `activeUserId` 变化后重新加载数据。
3. **切换用户**：从 `userStore.users` 列表中选择 → 更新 `activeUserId` → store 重新加载；B 站相关请求自动带上新用户的 Cookie。
4. **退出登录**：只清理对应用户的 session，不删除该用户的数据；允许“清除该用户”操作（删除会话 + 数据 key）。
5. **游客转正**：当 `local:legacy`（或 `local:guest`）首次登录成功，弹框询问是否把当前离线数据迁移到新 B 站账号；选择“是”则把 `::<guest>` 下的数据复制到 `::bili:<uid>` 后删除 guest 数据。

---

## 6. UI 与交互改动

- **设置页新增卡片**：「账号与多用户」
  - 显示当前用户头像/昵称/来源。
  - 按钮：`切换用户`（弹出列表）、`登录B站`、`退出当前用户`、`删除该用户数据`。
- **全局状态指示**：底部导航或顶部头像展示当前用户昵称，点击可快速切换。
- **B 站登录入口**：保留 `OnlinePlayer` 内部入口，但应复用 `userStore` 的统一方法，避免状态不一致。
- **数据隔离提示**：在切换用户时提示“待办、徽章、下载等都会切换到该账号的数据”。

---

## 7. PWA 安装提示（PC / 移动端浏览器）

1. 在 `App.vue`（全局）监听 `beforeinstallprompt`：
   ```javascript
   let deferredPrompt = null
   window.addEventListener('beforeinstallprompt', (e) => {
     e.preventDefault()
     deferredPrompt = e
     installStore.markAvailable()
   })
   ```
2. 在顶部/底部展示 CTA（例如 Banner 或按钮），点击后：
   ```javascript
   await deferredPrompt.prompt()
   const { outcome } = await deferredPrompt.userChoice
   installStore.markResult(outcome === 'accepted')
   deferredPrompt = null
   ```
3. PC 与安卓 Chrome 共用上方流程；iOS Safari 无 `beforeinstallprompt`，检测 `navigator.userAgent` + 非 `standalone` 时展示“通过分享 → 添加到主屏幕”图文指引。
4. 若已安装（`matchMedia('(display-mode: standalone)').matches` 或 `navigator.standalone`），隐藏 CTA。

---

## 8. 开发任务清单（建议顺序）

1. 新增 `userStore`（管理用户元信息与切换事件），编写单元方法并落地到 `src/stores/`。
2. 改造 `bilibiliAuth` → `bilibili-auth-sessions`，暴露 `loadSessionFor(userId)`、`saveSession`、`clearSession`。
3. 各业务 store 接入 `activeUserId`，将存储 key 改为 `baseKey::<uid>`，并实现切换时的重置/加载。
4. 实现迁移脚本（应用启动时执行一次），生成 `local:legacy` / `bili:<uid>` 数据。
5. 设置页 UI：新增多用户卡片、切换弹窗、删除用户确认逻辑。
6. Web 端 PWA 安装提示组件，实现 `beforeinstallprompt` 缓存与 CTA。
7. 为各 store 增加 `resetAndLoad`/`removeDataFor`，统一调用于用户切换/删除流程。
8. 手动测试与回归（见下）。

---

## 9. 测试要点

- 登录两个不同 B 站账号，切换后待办/徽章/金币/下载列表互不干扰。
- 无登录（guest）状态使用后，再登录 B 站账号并选择“迁移数据”，确认数据完整搬迁且 guest 数据被清理。
- 旧版数据升级：已有 `focus-garden-data` 时升级不丢失；若旧版已登录 B 站，升级后自动识别为该 UID。
- B 站请求：切换账号后视频评论/收藏/历史接口使用对应 Cookie，未登录时提示登录。
- PWA 提示：PC Chrome/Edge 能弹出“安装到主屏幕”；安卓 Chrome 可触发 `beforeinstallprompt`；iOS 看到图文引导；已安装后不再提示。
- 数据安全：退出登录后对应 session 清除，重新进入需要重新登录；删除用户时关联的 `::<uid>` 数据被清空。

---

## 10. 风险与注意事项

- 本地保存 Cookie 存在被同设备其他人读取的风险；需在文案中提示“公共设备请退出账号”。
- `localStorage` 上限约 5MB，多个用户的数据量叠加需关注；必要时对历史记录/下载缓存做长度限制。
- 迁移脚本只执行一次，注意异常兜底（迁移失败时保留旧数据并提示重试）。
- PWA 提示频率需节制（如 24 小时内只提示一次），避免骚扰。
- 切换用户时的并发操作（计时中、下载中）需要暂停或提示，否则可能出现跨用户写入；建议切换时统一调用“暂停专注/暂停下载”。

---

如需补充设计或实现细节，请在上述任务对应的文件中新增注释或小节记录。***
