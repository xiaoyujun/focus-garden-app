# 数据存储与导入导出说明

本文档说明 Focus Garden 移动端 APK 的数据存储机制及导入导出功能。

---

## 一、数据存储概述

### 存储方式

应用使用 **localStorage** 作为主要数据持久化方案，各模块独立存储：

| 存储键 | 用途 | 模块 |
|--------|------|------|
| `focus-garden-data` | 核心应用数据 | `gameStore.js` |
| `focus-garden-badges` | 徽章收集数据 | `badgeStore.js` |
| `focus-garden-machines` | 推币机数据 | `badgeStore.js` |
| `audiobook-player-data` | 有声书播放器设置 | `audioStore.js` |
| `audiobook-last-played` | 最后播放的文件名 | `audioStore.js` |
| `audiobook-db` (IndexedDB) | Web 端目录句柄 | `audioStore.js` |
| `download-manager-data` | 下载任务与历史 | `downloadStore.js` |
| `platform-source-data` | 音频平台源配置 | `sourceStore.js` |

### 自动保存机制

各模块通过 Vue 的 `watch` 监听状态变化，自动触发 `saveToStorage()` 进行持久化：

```javascript
watch([todos, focusRecords, coins], saveToStorage, { deep: true })
```

---

## 二、核心数据结构

### 1. 主数据 (`focus-garden-data`)

```json
{
  "todos": [],              // 待办事项列表
  "todoGroups": [],         // 待办分组
  "recycleBin": [],         // 回收站
  "focusRecords": [],       // 专注记录
  "coins": 0,               // 金币数量
  "currentFocus": null,     // 当前专注任务
  "exportedAt": "ISO时间"   // 最后保存时间
}
```

### 2. 徽章数据 (`focus-garden-badges`)

```json
{
  "ownedBadges": ["badge_001", "badge_002"],
  "savedAt": "ISO时间"
}
```

### 3. 推币机数据 (`focus-garden-machines`)

```json
{
  "lastRefreshWeek": "2024-01-01",  // 上次刷新的周一日期
  "machines": [],                   // 推币机状态
  "drawHistory": [],                // 抽取历史（最多50条）
  "savedAt": "ISO时间"
}
```

### 4. 音频播放器数据 (`audiobook-player-data`)

```json
{
  "volume": 1,                    // 音量 (0-1)
  "playbackRate": 1,              // 播放速度
  "playMode": "sequence",         // 播放模式: sequence/single/shuffle
  "progressMemory": {},           // 各文件播放进度
  "directoryName": "音频书名",
  "lastIndex": 0,                 // 上次播放索引
  "nativePlaylistCache": []       // 移动端文件缓存
}
```

### 5. 下载管理数据 (`download-manager-data`)

```json
{
  "tasks": [],                    // 下载任务列表
  "downloadHistory": []           // 下载历史（最多100条）
}
```

### 6. 平台源数据 (`platform-source-data`)

```json
{
  "sources": [],                  // 音频源列表
  "currentSourceId": "xmly",      // 当前选中的源
  "searchHistory": [],            // 搜索历史
  "favorites": [],                // 收藏列表
  "playHistory": []               // 播放历史
}
```

---

## 三、导出功能

### 功能入口

**设置页面 → 数据管理 → 导出数据**

### 导出范围

导出的 JSON 文件包含以下数据：

| 字段 | 说明 |
|------|------|
| `todos` | 所有待办事项 |
| `todoGroups` | 待办分组配置 |
| `recycleBin` | 回收站内容 |
| `focusRecords` | 全部专注记录 |
| `coins` | 当前金币余额 |
| `exportedAt` | 导出时间戳 |
| `version` | 数据格式版本号 |

### 导出文件格式

```
focus-garden-YYYY-MM-DD.json
```

### 代码实现

```javascript
// src/views/Settings.vue
async function handleExport() {
  const fileName = `focus-garden-${new Date().toISOString().slice(0, 10)}.json`
  const data = store.exportData()
  if (Capacitor.isNativePlatform()) {
    const { Filesystem, Directory, Encoding } = await import('@capacitor/filesystem')
    await Filesystem.mkdir({ path: 'FocusGarden', directory: Directory.Documents, recursive: true }).catch(() => {})
    await Filesystem.writeFile({
      path: `FocusGarden/${fileName}`,
      data,
      directory: Directory.Documents,
      encoding: Encoding.UTF8
    })
    alert('导出成功，已保存到系统“文件/文档/FocusGarden”目录')
  } else {
    const blob = new Blob([data], { type: 'application/json' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = fileName
    document.body.appendChild(a)
    a.click()
    document.body.removeChild(a)
    URL.revokeObjectURL(url)
  }
}
```

### 导出可靠性（移动端）

- Android WebView 的 `<a download>` 在部分机型/系统上会被拦截；若点击无反应，请先检查是否授予“文件和媒体”权限，并确认文件管理器未将下载目录隐藏。
- APK 内置导出会调用系统下载器，默认保存到 `Download` 或 `下载` 目录；如未出现文件，可尝试在文件管理器的“最近”或“内部存储/Download”中搜索 `focus-garden-YYYY-MM-DD.json`。
- 当系统下载器被禁用/精简版 ROM 无下载器时，导出会失败。这种情况下请在应用内选择“复制 JSON 文本”备份，或使用分享面板（若有）将 JSON 发送到微信/邮箱再保存为文件。
- 文件体积超过 5MB 时，部分旧设备会直接丢弃下载请求。建议先清理回收站或分批导出（仅保留必要数据后再导出）。
- 导出后务必在文件管理器里实际找到文件并尝试打开校验，确认内容为 JSON 而非空文件。

---

## 四、导入功能

### 功能入口

**设置页面 → 数据管理 → 导入数据**

### 导入方式

1. **文件选择** - 选择本地 `.json` 文件
2. **粘贴 JSON** - 直接粘贴 JSON 文本

### 导入逻辑

```javascript
// src/stores/gameStore.js
function importData(jsonString) {
  try {
    const data = JSON.parse(jsonString)
    if (data.todos) todos.value = data.todos
    if (data.todoGroups) todoGroups.value = data.todoGroups
    if (data.recycleBin) recycleBin.value = data.recycleBin
    if (data.focusRecords) focusRecords.value = data.focusRecords
    if (data.coins !== undefined) coins.value = data.coins
    saveToStorage()
    return { success: true }
  } catch (e) {
    return { success: false, error: e.message }
  }
}
```

### 注意事项

- 导入会 **覆盖** 现有数据，非合并
- 只覆盖文件中存在的字段，缺失字段保持原值
- 导入失败时返回错误信息，不影响原数据

---

## 五、数据清除

### 功能入口

**设置页面 → 数据管理 → 清除所有数据**

### 清除范围

调用 `clearAllData()` 会重置以下内容：

| 数据项 | 重置后值 |
|--------|----------|
| `todos` | `[]` |
| `todoGroups` | 内置默认分组 |
| `recycleBin` | `[]` |
| `focusRecords` | `[]` |
| `coins` | `0` |
| `currentFocus` | `null` |

### 安全措施

- 清除前需用户二次确认
- 徽章数据独立存储，主数据清除不影响徽章

---

## 六、移动端特殊处理

### Capacitor 环境

在移动端（Android/iOS），数据仍通过 `localStorage` 存储，由 Capacitor 的 WebView 提供支持。

### 音频文件缓存

移动端音频播放器使用 `nativePlaylistCache` 缓存文件路径信息：

```javascript
nativePlaylistCache.value = audioFiles
  .slice(0, 500)  // 限制最多500条
  .map(file => ({ name: file.name, path: file.path }))
```

恢复播放时会验证文件可读性：

```javascript
await Filesystem.stat({ path: item.path })
```

### 数据位置 (Android)

```
/data/data/com.focusgarden.app/app_webview/Default/Local Storage/
```

> ⚠️ 该目录需要 root 权限访问，普通用户通过应用内导出功能备份数据。

### 导出失败排查（移动端）

1. **先确认权限**：进入系统设置 → 应用管理 → Focus Garden → 权限，开启“文件和媒体/存储”权限。无权限时下载器会直接拒绝写入。
2. **检查下载目录**：部分 ROM 会把下载器产物放在 `Download`、`下载` 或 `内部存储/Android/data/<浏览器包名>/files/Download`。使用文件管理器搜索 `focus-garden` 关键词。
3. **看是否生成 0B 文件**：若出现空文件，通常是下载器被禁用或空间不足；请释放存储空间后重试。
4. **使用备用方案**：设置页中若提供“复制 JSON 文本/剪贴板导出”，请先复制后粘贴到记事本保存；或在“分享”面板中发送到云盘/邮件。
5. **仍无法导出**：可在调试时打开 `adb logcat` 观察 `DownloadManager` 或 WebView 的错误，重点关注“Permission denied”“No such file or directory”等信息。

---

## 七、数据迁移与兼容性

### 版本号

导出数据包含 `version` 字段用于兼容性检查：

```json
{
  "version": "2.1",
  ...
}
```

### 向后兼容

导入时使用条件检查，确保缺失字段不会导致错误：

```javascript
if (data.todoGroups && data.todoGroups.length > 0) {
  todoGroups.value = data.todoGroups
}
```

---

## 八、最佳实践

1. **定期备份** - 建议每周导出一次数据
2. **多设备同步** - 可通过导出/导入实现设备间数据迁移
3. **升级前备份** - 应用更新前建议导出数据
4. **云存储** - 将导出文件保存到云盘（如 iCloud、Google Drive）

---

## 九、常见问题

### Q: 导出的文件在哪里？
**A:** Android 端通常保存在 `Download` 文件夹，iOS 端可通过分享功能保存。

### Q: 导入失败怎么办？
**A:** 检查 JSON 格式是否正确，可使用在线 JSON 验证工具检测语法错误。

### Q: 清除数据后能恢复吗？
**A:** 如果之前导出过备份，可以通过导入恢复；否则数据无法恢复。

### Q: 换手机后数据丢失了？
**A:** 应用数据不会自动同步，需要在旧设备导出数据，然后在新设备导入。
