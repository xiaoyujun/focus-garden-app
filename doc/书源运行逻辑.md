# 书源运行逻辑

## 1. 数据层（Pinia store）
- loadFromStorage（src/stores/bookSourceStore.js:204-250）按 v3/v2/旧格式分别加载本地数据，首次启动时通过 utoImportDefaultSubscription（src/stores/bookSourceStore.js:259-275）自动导入预设书源，避免空白状态；watch 监听关键 ref 并调用 saveToStorage（src/stores/bookSourceStore.js:288-300）实现持久化。
- 
ormalizeSource + importFromUrl（src/stores/bookSourceStore.js:45-384）统一 Legado/第三方 JSON 格式、支持只保留有声书源、同步新增/更新/删除；ddSubscription/
efreshSubscription/
emoveSubscription（src/stores/bookSourceStore.js:428-515）封装订阅生命周期、同步源数量与启用状态，保证 UI 中显示的数据可靠。
- enabledSources/sourcesBySubscription 等计算属性配合 currentSourceId，让页面可以以分组方式展示源；ddSearchHistory（src/stores/bookSourceStore.js:529-541）、ddFavorite/ddPlayHistory（src/stores/bookSourceStore.js:544-564）等方法则提供搜索记录、书架与播放历史的统一入口。

## 2. 第三方书源服务层
- etchUrl（src/services/thirdPartySourceService.js:31-70）根据运行环境切换原生请求或 /api/proxy，同时支持 GET/POST、字符集与额外头部，保障跨域请求稳定。
- parseRule（src/services/thirdPartySourceService.js:114-150）、extractFromHtml、extractFromJson 等工具将 CSS/JSONPath/正则等规则标准化，parseUrlTemplate + 
esolveUrlTemplate（src/services/thirdPartySourceService.js:269-382）处理 Legado 特有的 {{key}}、@ 等占位符，生成可请求的搜索地址。
- searchWithSource（src/services/thirdPartySourceService.js:397-465）组合 URL、判断 JSON 还是 HTML 返回、提取封面/标题/作者等字段并解相对路径；getBookChapters（src/services/thirdPartySourceService.js:584-639）通过章节列表规则解析章节数组，getChapterAudioUrl（src/services/thirdPartySourceService.js:659-733）则用 udioUrlRule 或页面中的音频元素/脚本正则定位音频地址；alidateSource（src/services/thirdPartySourceService.js:735-756）提供额外的可用性检测。

## 3. 页面层与交互流程（BookSourcePlayer）
- 搜索入口由 handleSearch（src/views/BookSourcePlayer.vue:167-228）实现：遍历 ookSourceStore.enabledSources 并发调用 searchWithSource，去重后合并结果，展示进度与失败源，并将关键词写入书源 store 的搜索历史；失败时提示用户检查网络或源配置。
- iewBookDetail（src/views/BookSourcePlayer.vue:245-271）获取章节列表，playFromChapter（src/views/BookSourcePlayer.vue:274-339）构建播放列表并交给 loadAndPlay（src/views/BookSourcePlayer.vue:352-420）调取 getChapterAudioUrl，播放成功后调用 ookSourceStore.addPlayHistory 记录书架历史。
- 播放器在 loadAndPlay 中引入 <audio> 控制，与 persistProgress/loadProgressFromStorage（src/views/BookSourcePlayer.vue:106-149）配合定期保存播放进度；onMounted/onUnmounted（src/views/BookSourcePlayer.vue:634-638）负责初始化进度与移除事件监听，防止切换页面丢失状态。
- 页面右上角的书源管理按钮打开弹窗，调用 ookSourceStore 的订阅与源管理 API（例如 ddSubscription、	oggleSource、
emoveSubscription），同时在书架/收藏列表中通过 ookSourceStore.addFavorite/
emoveFavorite 控制书籍状态。

## 4. 总结
书源系统在 store + service + 视图之间按职责分层：store 负责缓存与订阅管理，service 封装 HTTP/规则解析，BookSourcePlayer 通过这些接口实现搜索、章节展示、播放与书架操作。需要扩展功能时可优先在服务层补充解析规则，再通过 store 曝光新的操作，最后在页面消费。
